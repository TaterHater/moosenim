<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>WebVR Test</title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112336897-1"></script>
    <script>
        window.dataLayer = window.dataLayer || []
        function gtag() { dataLayer.push(arguments) }
        gtag('js', new Date())

        gtag('config', 'UA-112336897-1')
    </script>
    <script src="https://aframe.io/releases/0.6.1/aframe.min.js"></script>
    <!--Aframe api main-->
    <script src="https://unpkg.com/aframe-animation-component@3.2.1/dist/aframe-animation-component.min.js"></script>
    <!--Aframe animation API-->
    <script src="https://unpkg.com/aframe-particle-system-component@1.0.x/dist/aframe-particle-system-component.min.js"></script>
    <!--Aframe particle system-->
    <script src="https://unpkg.com/aframe-outline@%5E1.1.0/build/aframe-outline.min.js"></script>

    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>
    <!--socket.io and Ajax APIs-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>


    <style>
    </style>
</head>


<body>
    <script>
       
        var URL_SERVER = 'https://moosen.im:443'
        var socket = io.connect(URL_SERVER)
        var event
        var camera = document.getElementById("controller")
        var theBox = document.getElementById("theBox")
       // var ground = document.getElementById("ground")
        $(function () {
            var uid = socket.id
            var sceneEl = document.querySelector('a-scene')
            var Xpos = Math.random(10) * 10
            var Zpos = Math.random(10) * 10
            var totalPlayers = []
            // ground.Three.Color = new Three.Color(0x003711)
            socket.emit('vrconnection', uid, Xpos, Zpos)
            var p = { x: Xpos, z: Zpos, uid: uid }
            var avatar = document.createElement('a-entity')
            // avatar.setAttribute('position' , { x: Xpos, y: Ypos, z: -5 })
            uid = socket.id
            avatar.setAttribute('geometry', {
                primitive: 'cylinder',
                height: 1.5,
                radius: 0.5
            })
            avatar.setAttribute('material', 'color', 'red')

            socket.emit('vrconnection', uid, Xpos, Zpos)

            socket.on('vrUpdatePos', function (players) {
                console.log("successful reply")
                // console.log(players[0].x)
                // console.log(players.length + "player total")
                for (var i = 0; i < players.length; i++) {

                    var avatar = document.createElement('a-entity')
                    avatar.setAttribute('position', { x: players[i].x, y: 1, z: players[i].z })

                    avatar.setAttribute('geometry', {
                        primitive: 'cylinder',
                        height: 1.5,
                        radius: 0.5
                    })
                    avatar.setAttribute('material', 'color', 'red')
                    sceneEl.appendChild(avatar)

                }


            })
            console.log("before")


            var camera = document.getElementById("controller")
            var oldX = camera.object3D.position.x
            var oldZ = camera.object3D.position.z
            console.log("after")
            socket.on('vrTest', function () {
                if (camera.object3D.position.x != oldX || camera.object3D.position.z != oldZ) {
                    oldX = camera.object3D.position.x
                    oldZ = camera.object3D.position.z
                    theBox.object3D.position.x = oldX
                    theBox.object3D.position.z = oldZ
                    console.log('box x: ' + theBox.object3D.position.x + ' box z: ' + theBox.object3D.position.z)
                    socket.emit('vrSyncPos', uid, camera.position.x, camera.position.z)
                }
            })
        })
    </script>

    <a-scene>
        <a-assets>
            
        </a-assets>

        <a-entity hand-controls="left"></a-entity>
        <a-entity hand-controls="right"></a-entity>
        <a-entity id="controller" position="0,-3,0 ">
            <a-camera></a-camera>
            <!--<a-entity  wasd-controls></a-entity>-->
        </a-entity>

        <a-box  id = "theBox" position="-1 0.5 -3" rotation="0 45 0"></a-box>
        <a-sphere  position="0 1.25 -5" radius="1.25"
            color="#EF2D5E" ></a-sphere>
        <a-cylinder  position="1 0.75 -3" radius="0.5"
            height="1.5" color="#FFC65D"></a-cylinder>
        <a-plane id="ground"  width = "10000" height = "10000"  material=" repeat: 100 100 metalness: 0.6 roughness: 0.4" rotation="-90 0 0"></a-plane>
        <a-entity particle-system="preset: snow particleCount: 10000"></a-entity>
        <a-sky color="#9bfcff"></a-sky>

    
</body>

</html>