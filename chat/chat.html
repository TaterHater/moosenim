<!doctype html>
<html>
<head>
    <link rel="icon" href="http://www.moosen.im/images/favicon.png">
    <meta charset="UTF-8">
    <title>Moosen Chat</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <!-- <script src="/js/materialize.js"></script> -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
    <!-- <script src="/siofu/client.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.1/js/materialize.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.1/css/materialize.min.css">
    <script src= "http://player.twitch.tv/js/embed/v1.js"></script>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
    #messages { list-style-type: none; margin: 0; }
    #chatrooms { background-color:black; }
    #chatrooms li{ color:#6EB7FF; }
    nav.top-nav a.page-title {
        line-height: 10vh;
        font-size: 4em;
    }
    .thumb {
        height: 200px;
        border: 1px solid #000;
        text-align:center
    }
    </style>
</head>
<body style="background-color:#000000;">
    <header>
        <nav class="top-nav center light-blue" style="height:10vh">
            <div class="container">
                <div class="nav-wrapper">
                    <a class="page-title white-text">MoosenIM</a>
                </div>
            </div>
        </nav>
        <div class="container">
            <a href="#" data-activates="nav-mobile" class="button-collapse top-nav full hide-on-large-only"><i class="material-icons">menu</i></a>
        </div>
        <ul id="nav-mobile" class="side-nav fixed" style="transform: translateX(0px);">
                <li class="logo"><a id="logo-container" href="/" class="brand-logo">
                    <object id="front-page-logo" type="image/svg+xml" data="res/materialize.svg">Your browser does not support SVG</object></a></li>
                <li class="search">
                  <div class="search-wrapper card">
                    <input id="search"><i class="material-icons">search</i>
                    <div class="search-results"></div>
                  </div>
                </li>
                <li class="bold"><a href="about.html" class="waves-effect waves-teal">About</a></li>
                <li class="bold"><a href="getting-started.html" class="waves-effect waves-teal">Getting Started</a></li>
                <li class="no-padding">
                  <ul class="collapsible collapsible-accordion">
                    <li class="bold"><a class="collapsible-header waves-effect waves-teal">CSS</a>
                      <div class="collapsible-body">
                        <ul>
                          <li><a href="color.html">Color</a></li>
                          <li><a href="grid.html">Grid</a></li>
                          <li><a href="helpers.html">Helpers</a></li>
                          <li><a href="media-css.html">Media</a></li>
                          <li><a href="pulse.html">Pulse</a></li>
                          <li><a href="sass.html">Sass</a></li>
                          <li><a href="shadow.html">Shadow</a></li>
                          <li><a href="table.html">Table</a></li>
                          <li><a href="css-transitions.html">Transitions</a></li>
                          <li><a href="typography.html">Typography</a></li>
                        </ul>
                      </div>
                    </li>
                    <li class="bold"><a class="collapsible-header waves-effect waves-teal">Components</a>
                      <div class="collapsible-body">
                        <ul>
                          <li><a href="badges.html">Badges</a></li>
                          <li><a href="buttons.html">Buttons</a></li>
                          <li><a href="breadcrumbs.html">Breadcrumbs</a></li>
                          <li><a href="cards.html">Cards</a></li>
                          <li><a href="chips.html">Chips</a></li>
                          <li><a href="collections.html">Collections</a></li>
                          <li><a href="footer.html">Footer</a></li>
                          <li><a href="forms.html">Forms</a></li>
                          <li><a href="icons.html">Icons</a></li>
                          <li><a href="navbar.html">Navbar</a></li>
                          <li><a href="pagination.html">Pagination</a></li>
                          <li><a href="preloader.html">Preloader</a></li>
                        </ul>
                      </div>
                    </li>
                    <li class="bold active"><a class="collapsible-header active waves-effect waves-teal">JavaScript</a>
                      <div class="collapsible-body" style="display: block;">
                        <ul>
                          <li><a href="carousel.html">Carousel</a></li>
                          <li class="active"><a href="collapsible.html">Collapsible</a></li>
                          <li><a href="dialogs.html">Dialogs</a></li>
                          <li><a href="dropdown.html">Dropdown</a></li>
                          <li><a href="feature-discovery.html">FeatureDiscovery</a></li>
                          <li><a href="media.html">Media</a></li>
                          <li><a href="modals.html">Modals</a></li>
                          <li><a href="parallax.html">Parallax</a></li>
                          <li><a href="pushpin.html">Pushpin</a></li>
                          <li><a href="scrollfire.html">ScrollFire</a></li>
                          <li><a href="scrollspy.html">Scrollspy</a></li>
                          <li><a href="side-nav.html">SideNav</a></li>
                          <li><a href="tabs.html">Tabs</a></li>
                          <li><a href="transitions.html">Transitions</a></li>
                          <li><a href="waves.html">Waves</a></li>
                        </ul>
                      </div>
                    </li>
                  </ul>
                </li>
                <li class="bold"><a href="mobile.html" class="waves-effect waves-teal">Mobile</a></li>
                <li class="bold"><a href="showcase.html" class="waves-effect waves-teal">Showcase</a></li>
                <li class="bold"><a href="themes.html" class="waves-effect waves-teal">Themes<span class="new badge"></span></a></li>
              </ul>
        <!-- <ul id="nav-mobile" class="side-nav fixed grey darken-4" style="transform: translateX(0px);">
            <li class="logo"><a id="logo-container" href="http://www.moosen.im/" class="brand-logo">
                <svg id="front-page-logo" preserveAspectRatio="xMidYMid meet" viewbox="0 0 100 100" data="/images/moosen.svg">Your browser does not support SVG</object></a></li>
            <li>
                <ul id="chatrooms">
                    <li><h4 style="color:white">Chatrooms</h4></li>
                </ul>
            </li>
        </ul> -->
    </header>
    <div id="main">
        <div class="row" style ="padding-top:5vh;">
            <div class="row col s12 xl8 offset-xl2">
                <ul class="collection with-header" id="messages" style="overflow-x:hidden"></ul>
            </div>
            <div class="row col s12 xl8 offset-xl2">
                <form id="mform" action="">
                    <input id="m" autocomplete="off" style="color:black; background-color:white; border:2px solid #6EB7FF; font-size:1.5em" type="text" placeholder="Message">
                    <br>
                    <button id="mbut" class="btn waves-effect waves-light light-blue white-text"><i class="material-icons">send</i></button>
                </form>
                <!-- <button id="post" class="btn waves-effect waves-light light-blue white-text"><i class="material-icons">send</i></button> -->
                <label name="files[]" id="add_pics" class="btn btn-floating btn-file multiple waves-effect waves-light light-blue">
                    <i class="material-icons">add</i><input style="display: none;" type="file" multiple>
                </label>
                <br>
                <!-- <output id="list"></output> -->
            </div>
        </div>
    </div>
    <!-- <div class="container">
    <div class="center row col s12">
    <img style="height:10vh" src="http://moosen.im/images/banner.png" alt="Mighty Moosen">
</div>
</div> -->

<!-- <div class="container">
<div class="col hide-on-small-only s2">
<div class="toc-wrapper pinned">
<ul class="collection with-header" id="online" style="overflow-x:hidden"></ul>
</div>
</div>
</div> -->

<!-- Socket.io -->
<script>
$(function () {
    canAuto = false;
    // last_id = 0;
    var socket = io();
    // var siofu = new SocketIOFileUpload(socket);
    // siofu.addEventListener("start", function(event){
    //     event.file.meta.filetype = event.file.type;
    // });


    //roomList holds an array of all chatrooms a user has access to. 
    var roomList;
    var userid = "104635400788300812127";
    $('#mform').submit(function(){
        var message = $('#m').val();
        message = message.replace(/</g, '&lt;');
        message = message.replace(/>/g, '&gt;');
        socket.emit('chat message', encodeURI(message));
        $('#m').val('');
        return false;
    });


    $(document).ready(function(){
        var res = window.location.href.substring(31);
      //  console.log(res);
        socket.emit('associate', res);

    });

    document.getElementById("main").style.display = "inline";
    socket.on('chat message', function (user, msg, time, id, pic) {
        document.title = user.substring(0,3) + ": " + decodeURI(msg);

        var m = decodeURI(msg);
        if(document.hidden) {
            notifyMe(m, pic);
        }
        //get rooms
       // socket.emit('getrooms', userid);
       
        $('#messages').append('<li class="collection-item avatar"><img src="' + pic + '" alt="" class="circle"><span class="title">'
        + user + '</span><p>'
        + decodeURI(msg) + '</p><span style="font-size:0.8em; color:#9F9F9F; float:right;" class="secondary-content">'
        + time + '</a></li>');
        if (canAuto) {
            window.scrollTo(0,document.body.scrollHeight);
        }
    });
    socket.on('login', function (displayName, email, photoURL, uid) {
        console.log("logging in " + displayName);

        socket.emit('getrooms', uid);
        
        $('#messages').append('<li class="collection-item"><i style="color:#9F9F9F;" class="material-icons circle">info outline</i><span style="font-size:0.5em; color:#9F9F9F; float:right;" class="secondary-content">'
        + displayName + ' logged in</span></a></li>');
        if (canAuto) {
            window.scrollTo(0,document.body.scrollHeight);
        }
    });
    socket.on('test', function (name) {
        console.log(name + "asdasd");
    });
    socket.on('roomlist', function (list) {
        console.log("Received roomlist: " + list);
        $('#chatrooms').empty();
        $('#chatrooms').append('<li><h4 style="color:white">Chatrooms</h4></li>');
        list.forEach(function(element) {
            $('#chatrooms').append('<li><h2 style="color:#6EB7FF">' + element + '</h2></li>');
        });
    });
    socket.on('retreat', function () {
        console.log("Retreat!");
        window.location.href = "http://www.moosen.im/";
    });
    socket.on('logout message', function(user){
        $('#messages').append('<li class="collection-item"><i style="color:#9F9F9F;" class="material-icons circle">error outline</i><span style="font-size:0.5em; color:#9F9F9F; float:right;" class="secondary-content">'
        + user + ' logged out</span></a></li>');
        if (canAuto) {
            window.scrollTo(0,document.body.scrollHeight);
        }
    });

    // socket.on('update online', function(users){
    //     document.getElementById("online").style.display = "none";
    //     $('#online').empty();
    //     $('#online').append('<li class="collection-header">Online</li>');
    //     for (var i = 0; i < users.length; i++) {
    //         $('#online').append('<li class="collection-item">' + users[i] + '</li>');
    //     }
    //     if (canAuto) {
    //         window.scrollTo(0,document.body.scrollHeight);
    //     }
    //     document.getElementById("online").style.display = "block";
    // });
    // function handleFileSelect(evt) {
    //     console.log('In handleFileSelect');
    //     var files = evt.target.files; // FileList object
    //
    //     for (var i = 0; i < files.length; i++) {
    //         var name = files[i].name;
    //         var type = files[i].type;
    //         console.log("Filename: " + name + " , Type: " + type);
    //         siofu.submitFiles([files[i]]);
    //     }
    //     // Loop through the FileList and render image files as thumbnails.
    //     // for (var i = 0, f; f = files[i]; i++) {
    //     //     console.log('In for loop turn ' + i);
    //     //     console.log('File name: ' + f.name);
    //     //     // Only process image files.
    //     //     if (!f.type.match('image.*')) {
    //     //         continue;
    //     //     }
    //     //
    //     //     var reader = new FileReader();
    //     //
    //     //     Closure to capture the file information.
    //     //     reader.onload = (function(theFile) {
    //     //         return function(e) {
    //     //
    //     //             // TODO: Render thumbnail.
    //     //             var span = document.createElement('span');
    //     //             span.setAttribute('data-ondeleteId', escape(theFile.name));
    //     //             span.innerHTML = ['<img id="', escape(theFile.name), '" class="thumb" src="', e.target.result,
    //     //             '" title="', escape(theFile.name), '"/>'].join('');
    //     //             document.getElementById('list').insertBefore(span, null);
    //     //
    //     //             // TODO: This code will be used later to delete pictures prior to upload
    //     //             var del = document.createElement('button');
    //     //             del.className = 'btn btn-floating waves-effect waves-light red';
    //     //             del.setAttribute('onclick', 'dele("' + escape(theFile.name) + '")')
    //     //             del.id = escape(theFile.name) + 'del';
    //     //             del.innerHTML = ['<i class="material-icons">clear</i>'];
    //     //             document.getElementById('list').insertBefore(del, null);
    //     //         };
    //     //     })(f);
    //     //
    //     //     // Read in the image file as a data URL.
    //     //     reader.readAsArrayBuffer(f);
    //     // }
    // }
    // document.getElementById('add_pics').addEventListener('change', handleFileSelect, false);

    // function dele(n) {
    //     var d = document.getElementById(n);
    //     var d_b = document.getElementById(n + 'del');
    //     d.remove();
    //     d_b.remove();
    // }
});
$(window).scroll(function() {
    if($(window).scrollTop() + $(window).height() >= $(document).height() * .9) {
        canAuto = true;
    }
    else {
        canAuto = false;
    }
});

$(window).resize(function () { //checking for window resize event
    if($("#m").is(":focus")){
        window.scrollTo(0,document.body.scrollHeight);
        window.scrollTo(0,document.body.scrollHeight);
    }
});

$(document).ready(function(){
    $('.materialboxed').materialbox();
});
</script>

<script>
if (window.File && window.FileReader && window.FileList && window.Blob) {
    // Great success! All the File APIs are supported.
} else {
    alert('The File APIs are not fully supported in this browser.');
}
</script>

<script>
//notification code
document.addEventListener('DOMContentLoaded', function () {
    if (!Notification) {
        alert('dis broke as shit');
        return;
    }
    if (Notification.permission !== "granted")
    Notification.requestPermission();
});

function notifyMe(msg, pic) {
    if (Notification.permission !== "granted")
    Notification.requestPermission();
    else {
        var notification = new Notification('Moosen IM', {
            icon: pic,
            body: msg,
        });
        notification.onclick = function () {
            window.focus();
        };
    }
}

</script>
</body>
</html>
